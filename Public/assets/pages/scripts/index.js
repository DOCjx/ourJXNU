var Index=function(){var t=function(){var t=$("ul.chat-list"),a=(new Date).valueOf(),e=function(){$(".chat-scroller").not(".scroller-initialized").addClass("scroller-initialized").slimScroll({height:"352px",allowPageScroll:!0,size:"7px",color:"#bbb",railColor:"#eaeaea",start:"bottom"}),$(".chat-scroller").hasClass("scroller-initialized")&&$(".chat-scroller").slimScroll({scrollBy:"-20px"}).bind("slimscroll",function(t,a){switch(a){case"bottom":$(".chat-scroller").slimScroll({scrollBy:"-2px"}),n()}})},l=function(a){var l='<li class="{:_type}" data-type="{:_type}"><img class="avatar" alt="头像" src="{:avatar_file}" /><div class="message"><span class="arrow"></span><a href="javascript:;" class="name">{:user_id_text}</a><span class="datetime">&nbsp;|&nbsp;{:create_time}</span><span class="body"> &nbsp;{:content} </span></div></li>',n="",i={},s=t.find("li:last");s.size()&&(i.type="in"==s.data("type"),i.user_id_text=$.trim(s.find(".name").text())),$.each(a.list,function(t,e){var s=!1;a.list[t-1]&&(i=a.list[t-1]),s=e.user_id_text==i.user_id_text?i.type:!i.type,a.list[t].type=s,e._type=s?"in":"out",n+=l.replace(/\{:(\w+)}/g,function(t,a){return e[a]||""})}),t.data("offset",a.offset).append(n),$(".chat-scroller").hasClass("scroller-initialized")&&($(".chat-scroller").slimScroll({scrollBy:70*a.list.length+"px"}),e())};$.post($.U("HyChat/ajax?q=list"),function(t){t.status&&(l(t.data),e())}),$content=$('[name="input-chat"]',$(".chats")),$(".btn-chat").on("click",function(){var e=$(this);e.prop("disabled",!0);var n=$.trim($content.val()),i=t.data("offset");return!!n&&(a=(new Date).valueOf(),void $.post($.U("HyChat/ajax?q=add"),{content:n,offset:i},function(t){return $content.val(""),e.prop("disabled",!1),t.status?void l(t.data):$.actionAlert(t)}))}),$content.on("keypress",function(t){if(13==t.which)return $(".btn-chat").trigger("click"),!1}),$(".reload",$(".chats")).on("click",function(){n()});var n=function(){if((new Date).valueOf()-a<3e3)return!1;$.loading(".chat-scroller-wrapper","刷新列表...");var e=t.data("offset");return!!e&&(a=(new Date).valueOf(),void $.post($.U("HyChat/ajax?q=refresh"),{offset:e},function(t){return $.unloading(".chat-scroller-wrapper"),!!t.status&&void l(t.data)}))}},a=function(){$(".time-now").html($.date("Y年m月d日 x")),$(".notice").on("click",".notice-file-down",function(t){t.preventDefault(),t.stopPropagation(),location.href=$(this).data("url")})};return{init:function(){a(),t()}}}();